============================= test session starts ==============================
platform linux -- Python 3.10.14, pytest-8.4.2, pluggy-1.6.0
rootdir: /mnt/c/development/phentrieve
configfile: pyproject.toml
testpaths: tests
plugins: timeout-2.4.0, asyncio-0.21.1, xdist-3.8.0, respx-0.22.0, mock-3.14.1, anyio-4.9.0, cov-6.2.1
asyncio: mode=strict
collected 87 items

tests/cli/test_query_commands.py .........F                              [ 11%]
tests/cli/test_similarity_commands.py ........                           [ 20%]
tests/test_assertion_detection.py ...FF..                                [ 28%]
tests/test_basic_chunkers.py ..................................          [ 67%]
tests/test_chunking_pipeline_integration.py .....                        [ 73%]
tests/test_resource_loader.py .....                                      [ 79%]
tests/test_semantic_metrics.py ........                                  [ 88%]
tests/test_sliding_window_chunker.py ........../home/bernt/miniforge3/lib/python3.10/site-packages/coverage/control.py:915: CoverageWarning: No data was collected. (no-data-collected)
  self._warn("No data was collected.", slug="no-data-collected")
                          [100%]

=================================== FAILURES ===================================
______________________ test_query_output_file_write_error ______________________

mock_query_results = <MagicMock name='orchestrate_query' id='128295236612112'>

    def test_query_output_file_write_error(mock_query_results):
        """Test query command with an invalid output file path."""
        # Try to write to a directory that doesn't exist
        invalid_path = "/nonexistent/dir/output.txt"
    
        with patch("phentrieve.cli.query_commands.open") as mock_open:
            # Simulate a permission or filesystem error
            mock_open.side_effect = PermissionError("Permission denied")
    
            result = runner.invoke(
                app, ["query", "seizures", "--output-file", invalid_path]
            )
    
            assert result.exit_code == 1
>           assert "Error writing to file: Permission denied" in result.stdout
E           assert 'Error writing to file: Permission denied' in "2025-11-15 11:19:01,191 - INFO - Logging level set to INFO\nQuerying for HPO terms with text: 'seizures'\nError writing to file: [Errno 13] Permission denied: '/nonexistent'\n"
E            +  where "2025-11-15 11:19:01,191 - INFO - Logging level set to INFO\nQuerying for HPO terms with text: 'seizures'\nError writing to file: [Errno 13] Permission denied: '/nonexistent'\n" = <Result SystemExit(1)>.stdout

tests/cli/test_query_commands.py:277: AssertionError
___________ TestDependencyAssertionDetector.test_negation_detection ____________

self = <test_assertion_detection.TestDependencyAssertionDetector testMethod=test_negation_detection>

    def test_negation_detection(self):
        """Test detection of negation using dependency parsing."""
        # Test with various negation patterns
        test_cases = [
            ("Patient does not have fever", AssertionStatus.NEGATED),
            ("No evidence of heart disease was found", AssertionStatus.NEGATED),
            ("We did not observe any rash", AssertionStatus.NEGATED),
            ("Patient has fever", AssertionStatus.AFFIRMED),
        ]
    
        for text, expected_status in test_cases:
            status, details = self.detector.detect(text)
>           self.assertEqual(
                status,
                expected_status,
                f"Failed for text: '{text}', got {status} instead of {expected_status}",
            )
E           AssertionError: <AssertionStatus.AFFIRMED: 'affirmed'> != <AssertionStatus.NEGATED: 'negated'> : Failed for text: 'Patient does not have fever', got AssertionStatus.AFFIRMED instead of AssertionStatus.NEGATED

tests/test_assertion_detection.py:100: AssertionError
__ TestDependencyAssertionDetector.test_normality_detection_after_refactoring __

self = <test_assertion_detection.TestDependencyAssertionDetector testMethod=test_normality_detection_after_refactoring>

    def test_normality_detection_after_refactoring(self):
        """Test normality detection works correctly after refactoring."""
        # Test with various normality patterns that match our normality cues resource
        test_cases = [
            ("The patient's liver function is normal", AssertionStatus.NORMAL),
            ("Lungs are clear", AssertionStatus.NORMAL),
            ("Blood pressure within normal limits", AssertionStatus.NORMAL),
            ("Elevated heart rate noted", AssertionStatus.AFFIRMED),
        ]
    
        for text, expected_status in test_cases:
            status, details = self.detector.detect(text)
>           self.assertEqual(
                status,
                expected_status,
                f"Failed for text: '{text}', got {status} instead of {expected_status}",
            )
E           AssertionError: <AssertionStatus.AFFIRMED: 'affirmed'> != <AssertionStatus.NORMAL: 'normal'> : Failed for text: 'The patient's liver function is normal', got AssertionStatus.AFFIRMED instead of AssertionStatus.NORMAL

tests/test_assertion_detection.py:125: AssertionError
=============================== warnings summary ===============================
../../../../home/bernt/miniforge3/lib/python3.10/site-packages/torch/cuda/__init__.py:734
  /home/bernt/miniforge3/lib/python3.10/site-packages/torch/cuda/__init__.py:734: UserWarning: Can't initialize NVML
    warnings.warn("Can't initialize NVML")

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.10.14-final-0 _______________

Name                                                        Stmts   Miss  Cover   Missing
-----------------------------------------------------------------------------------------
api/__init__.py                                                 0      0   100%
api/dependencies.py                                            97     97     0%   1-240
api/main.py                                                    48     48     0%   1-148
api/routers/__init__.py                                         0      0   100%
api/routers/config_info_router.py                              35     35     0%   8-144
api/routers/health.py                                           5      5     0%   1-12
api/routers/query_router.py                                    63     63     0%   1-227
api/routers/similarity_router.py                               67     67     0%   8-177
api/routers/text_processing_router.py                         147    147     0%   1-423
api/run_api_local.py                                           51     51     0%   12-108
api/schemas/__init__.py                                         0      0   100%
api/schemas/config_info_schemas.py                             35     35     0%   8-179
api/schemas/query_schemas.py                                   33     33     0%   1-93
api/schemas/similarity_schemas.py                              18     18     0%   8-94
api/schemas/text_processing_schemas.py                         56     56     0%   1-179
phentrieve/__init__.py                                          1      1     0%   8
phentrieve/__main__.py                                          6      6     0%   2-11
phentrieve/cli/__init__.py                                     19     19     0%   7-67
phentrieve/cli/benchmark_commands.py                           44     44     0%   6-249
phentrieve/cli/data_commands.py                                14     14     0%   6-48
phentrieve/cli/index_commands.py                               15     15     0%   6-74
phentrieve/cli/query_commands.py                               90     90     0%   6-360
phentrieve/cli/similarity_commands.py                          70     70     0%   8-193
phentrieve/cli/text_commands.py                               203    203     0%   6-771
phentrieve/cli/utils.py                                        98     98     0%   6-227
phentrieve/config.py                                           55     55     0%   8-267
phentrieve/data_processing/__init__.py                          0      0   100%
phentrieve/data_processing/document_creator.py                 68     68     0%   8-168
phentrieve/data_processing/hpo_parser.py                      266    266     0%   13-581
phentrieve/data_processing/test_data_loader.py                 27     27     0%   8-124
phentrieve/embeddings.py                                       32     32     0%   8-81
phentrieve/evaluation/__init__.py                               2      2     0%   8-10
phentrieve/evaluation/benchmark_orchestrator.py                76     76     0%   8-218
phentrieve/evaluation/comparison_orchestrator.py              360    360     0%   8-942
phentrieve/evaluation/full_text_loader.py                      26     26     0%   8-66
phentrieve/evaluation/full_text_runner.py                     123    123     0%   9-356
phentrieve/evaluation/metrics.py                              211    211     0%   11-579
phentrieve/evaluation/result_analyzer.py                       99     99     0%   6-220
phentrieve/evaluation/runner.py                               269    269     0%   8-778
phentrieve/evaluation/semantic_metrics.py                     113    113     0%   9-372
phentrieve/indexing/__init__.py                                 0      0   100%
phentrieve/indexing/chromadb_indexer.py                        69     69     0%   8-188
phentrieve/indexing/chromadb_orchestrator.py                   57     57     0%   8-124
phentrieve/retrieval/__init__.py                                0      0   100%
phentrieve/retrieval/api_helpers.py                            66     66     0%   1-218
phentrieve/retrieval/dense_retriever.py                       109    109     0%   8-299
phentrieve/retrieval/output_formatters.py                      62     62     0%   8-184
phentrieve/retrieval/output_formatters_new.py                  56     56     0%   8-176
phentrieve/retrieval/query_orchestrator.py                    279    279     0%   9-892
phentrieve/retrieval/reranker.py                               36     36     0%   9-112
phentrieve/retrieval/text_attribution.py                       36     36     0%   9-100
phentrieve/text_processing/__init__.py                          3      3     0%   8-22
phentrieve/text_processing/assertion_detection.py             228    228     0%   8-587
phentrieve/text_processing/chunkers.py                        367    367     0%   9-1155
phentrieve/text_processing/cleaners.py                         11     11     0%   8-45
phentrieve/text_processing/hpo_extraction_orchestrator.py     100    100     0%   7-295
phentrieve/text_processing/pipeline.py                        123    123     0%   8-387
phentrieve/text_processing/resource_loader.py                  46     46     0%   8-149
phentrieve/utils.py                                           173    173     0%   8-456
phentrieve/visualization/__init__.py                            0      0   100%
phentrieve/visualization/plot_utils.py                        152    152     0%   6-358
-----------------------------------------------------------------------------------------
TOTAL                                                        4915   4915     0%
Coverage JSON written to file coverage-baseline.json
=========================== short test summary info ============================
FAILED tests/cli/test_query_commands.py::test_query_output_file_write_error
FAILED tests/test_assertion_detection.py::TestDependencyAssertionDetector::test_negation_detection
FAILED tests/test_assertion_detection.py::TestDependencyAssertionDetector::test_normality_detection_after_refactoring
============== 3 failed, 84 passed, 1 warning in 91.27s (0:01:31) ==============
